"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ImportRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var middlewares = _interopRequireWildcard(require("../middlewares"));

var _multer = _interopRequireDefault(require("multer"));

var _rest = _interopRequireDefault(require("../rest"));

var _node = require("parse/node");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ImportRouter {
  getOneSchema(req) {
    const className = req.params.className;
    return req.config.database.loadSchema({
      clearCache: true
    }).then(schemaController => schemaController.getOneSchema(className)).catch(error => {
      if (error === undefined) {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`));
      } else {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.'));
      }
    });
  }

  importRestObject(req, restObject, targetClass) {
    if (targetClass) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.owningId
      }, {
        [req.params.relationName]: {
          __op: 'AddRelation',
          objects: [{
            __type: 'Pointer',
            className: targetClass,
            objectId: restObject.relatedId
          }]
        }
      }, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return Promise.reject(new _node.Parse.Error(_node.Parse.Error.OBJECT_NOT_FOUND, 'Object not found'));
        } else {
          return Promise.reject(error);
        }
      });
    }

    if (restObject.createdAt) {
      delete restObject.createdAt;
    }

    if (restObject.updatedAt) {
      delete restObject.updatedAt;
    }

    if (restObject.objectId) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.objectId
      }, restObject, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return _rest.default.create(req.config, req.auth, req.params.className, restObject, req.info.clientSDK, {
            allowObjectId: true
          });
        } else {
          return Promise.reject(error);
        }
      });
    }

    return _rest.default.create(req.config, req.auth, req.params.className, restObject);
  }

  getRestObjects(req) {
    return new Promise(resolve => {
      let restObjects = [];
      let importFile;

      try {
        importFile = JSON.parse(req.file.buffer.toString());
      } catch (e) {
        throw new Error('Failed to parse JSON based on the file sent');
      }

      if (Array.isArray(importFile)) {
        restObjects = importFile;
      } else if (Array.isArray(importFile.results)) {
        restObjects = importFile.results;
      } else if (Array.isArray(importFile.rows)) {
        restObjects = importFile.rows;
      }

      if (!restObjects) {
        throw new Error('No data to import');
      }

      if (req.body.feedbackEmail) {
        if (!req.config.emailAdapter) {
          throw new Error('You have to setup a Mail Adapter.');
        }
      }

      resolve(restObjects);
    });
  }

  handleImport(req) {
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);
    let promise = null;

    if (req.params.relationName) {
      promise = this.getOneSchema(req).then(response => {
        if (!Object.prototype.hasOwnProperty.call(response.fields, req.params.relationName)) {
          throw new Error(`Relation ${req.params.relationName} does not exist in ${req.params.className}.`);
        } else if (response.fields[req.params.relationName].type !== 'Relation') {
          throw new Error(`Class ${response.fields[req.params.relationName].targetClass} does not have Relation type.`);
        }

        const targetClass = response.fields[req.params.relationName].targetClass;
        return Promise.all([this.getRestObjects(req), targetClass]);
      });
    } else {
      promise = Promise.all([this.getRestObjects(req)]);
    }

    promise = promise.then(([restObjects, targetClass]) => {
      return restObjects.reduce((item, object, index) => {
        item.pageArray.push(this.importRestObject.bind(this, req, object, targetClass));

        if (index && index % 100 === 0 || index === restObjects.length - 1) {
          const pageArray = item.pageArray.slice(0);
          item.pageArray = [];
          item.mainPromise = item.mainPromise.then(results => {
            return Promise.all(results.concat(pageArray.map(func => func())));
          });
        }

        return item;
      }, {
        pageArray: [],
        mainPromise: Promise.resolve([])
      }).mainPromise;
    }).then(results => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We have successfully imported your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}.`,
          to: req.body.feedbackEmail,
          subject: 'Import completed'
        });
      } else {
        return Promise.resolve({
          response: results
        });
      }
    }).catch(error => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We could not import your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}. Error: ${error}`,
          to: req.body.feedbackEmail,
          subject: 'Import failed'
        });
      } else {
        throw new Error('Internal server error: ' + error);
      }
    });

    if (req.body.feedbackEmail && emailControllerAdapter) {
      promise = Promise.resolve({
        response: 'We are importing your data. You will be notified by e-mail once it is completed.'
      });
    }

    return promise;
  }

  wrapPromiseRequest(req, res, handler) {
    return handler(req).then(data => {
      res.json(data);
    }).catch(err => {
      res.status(400).send({
        message: err.message
      });
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    const upload = (0, _multer.default)();
    router.post('/import_data/:className', upload.single('importFile'), // middlewares.allowCrossDomain,
    middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    router.post('/import_relation_data/:className/:relationName', upload.single('importFile'), // middlewares.allowCrossDomain,
    middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    return router;
  }

}

exports.ImportRouter = ImportRouter;
var _default = ImportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ltcG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJJbXBvcnRSb3V0ZXIiLCJnZXRPbmVTY2hlbWEiLCJyZXEiLCJjbGFzc05hbWUiLCJwYXJhbXMiLCJjb25maWciLCJkYXRhYmFzZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwidGhlbiIsInNjaGVtYUNvbnRyb2xsZXIiLCJjYXRjaCIsImVycm9yIiwidW5kZWZpbmVkIiwiUHJvbWlzZSIsInJlamVjdCIsIlBhcnNlIiwiRXJyb3IiLCJJTlZBTElEX0NMQVNTX05BTUUiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiLCJpbXBvcnRSZXN0T2JqZWN0IiwicmVzdE9iamVjdCIsInRhcmdldENsYXNzIiwicmVzdCIsInVwZGF0ZSIsImF1dGgiLCJvYmplY3RJZCIsIm93bmluZ0lkIiwicmVsYXRpb25OYW1lIiwiX19vcCIsIm9iamVjdHMiLCJfX3R5cGUiLCJyZWxhdGVkSWQiLCJpbmZvIiwiY2xpZW50U0RLIiwiY29kZSIsIk9CSkVDVF9OT1RfRk9VTkQiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJjcmVhdGUiLCJhbGxvd09iamVjdElkIiwiZ2V0UmVzdE9iamVjdHMiLCJyZXNvbHZlIiwicmVzdE9iamVjdHMiLCJpbXBvcnRGaWxlIiwiSlNPTiIsInBhcnNlIiwiZmlsZSIsImJ1ZmZlciIsInRvU3RyaW5nIiwiZSIsIkFycmF5IiwiaXNBcnJheSIsInJlc3VsdHMiLCJyb3dzIiwiYm9keSIsImZlZWRiYWNrRW1haWwiLCJlbWFpbEFkYXB0ZXIiLCJoYW5kbGVJbXBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwicHJvbWlzZSIsInJlc3BvbnNlIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZmllbGRzIiwidHlwZSIsImFsbCIsInJlZHVjZSIsIml0ZW0iLCJvYmplY3QiLCJpbmRleCIsInBhZ2VBcnJheSIsInB1c2giLCJiaW5kIiwibGVuZ3RoIiwic2xpY2UiLCJtYWluUHJvbWlzZSIsImNvbmNhdCIsIm1hcCIsImZ1bmMiLCJzZW5kTWFpbCIsInRleHQiLCJ0byIsInN1YmplY3QiLCJ3cmFwUHJvbWlzZVJlcXVlc3QiLCJyZXMiLCJoYW5kbGVyIiwiZGF0YSIsImpzb24iLCJlcnIiLCJzdGF0dXMiLCJzZW5kIiwibWVzc2FnZSIsImV4cHJlc3NSb3V0ZXIiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwidXBsb2FkIiwicG9zdCIsInNpbmdsZSIsIm1pZGRsZXdhcmVzIiwiaGFuZGxlUGFyc2VIZWFkZXJzIiwiZW5mb3JjZU1hc3RlcktleUFjY2VzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVPLE1BQU1BLFlBQU4sQ0FBbUI7QUFDeEJDLEVBQUFBLFlBQVksQ0FBQ0MsR0FBRCxFQUFNO0FBQ2hCLFVBQU1DLFNBQVMsR0FBR0QsR0FBRyxDQUFDRSxNQUFKLENBQVdELFNBQTdCO0FBRUEsV0FBT0QsR0FBRyxDQUFDRyxNQUFKLENBQVdDLFFBQVgsQ0FDSkMsVUFESSxDQUNPO0FBQUVDLE1BQUFBLFVBQVUsRUFBRTtBQUFkLEtBRFAsRUFFSkMsSUFGSSxDQUVDQyxnQkFBZ0IsSUFBSUEsZ0JBQWdCLENBQUNULFlBQWpCLENBQThCRSxTQUE5QixDQUZyQixFQUdKUSxLQUhJLENBR0VDLEtBQUssSUFBSTtBQUNkLFVBQUlBLEtBQUssS0FBS0MsU0FBZCxFQUF5QjtBQUN2QixlQUFPQyxPQUFPLENBQUNDLE1BQVIsQ0FDTCxJQUFJQyxZQUFNQyxLQUFWLENBQ0VELFlBQU1DLEtBQU4sQ0FBWUMsa0JBRGQsRUFFRyxTQUFRZixTQUFVLGtCQUZyQixDQURLLENBQVA7QUFNRCxPQVBELE1BT087QUFDTCxlQUFPVyxPQUFPLENBQUNDLE1BQVIsQ0FDTCxJQUFJQyxZQUFNQyxLQUFWLENBQ0VELFlBQU1DLEtBQU4sQ0FBWUUscUJBRGQsRUFFRSx5QkFGRixDQURLLENBQVA7QUFNRDtBQUNGLEtBbkJJLENBQVA7QUFvQkQ7O0FBRURDLEVBQUFBLGdCQUFnQixDQUFDbEIsR0FBRCxFQUFNbUIsVUFBTixFQUFrQkMsV0FBbEIsRUFBK0I7QUFDN0MsUUFBSUEsV0FBSixFQUFpQjtBQUNmLGFBQU9DLGNBQ0pDLE1BREksQ0FFSHRCLEdBQUcsQ0FBQ0csTUFGRCxFQUdISCxHQUFHLENBQUN1QixJQUhELEVBSUh2QixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FKUixFQUtIO0FBQUV1QixRQUFBQSxRQUFRLEVBQUVMLFVBQVUsQ0FBQ007QUFBdkIsT0FMRyxFQU1IO0FBQ0UsU0FBQ3pCLEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFBWixHQUEyQjtBQUN6QkMsVUFBQUEsSUFBSSxFQUFFLGFBRG1CO0FBRXpCQyxVQUFBQSxPQUFPLEVBQUUsQ0FDUDtBQUNFQyxZQUFBQSxNQUFNLEVBQUUsU0FEVjtBQUVFNUIsWUFBQUEsU0FBUyxFQUFFbUIsV0FGYjtBQUdFSSxZQUFBQSxRQUFRLEVBQUVMLFVBQVUsQ0FBQ1c7QUFIdkIsV0FETztBQUZnQjtBQUQ3QixPQU5HLEVBa0JIOUIsR0FBRyxDQUFDK0IsSUFBSixDQUFTQyxTQWxCTixFQW9CSnZCLEtBcEJJLENBb0JFLFVBQVNDLEtBQVQsRUFBZ0I7QUFDckIsWUFBSUEsS0FBSyxDQUFDdUIsSUFBTixLQUFlbkIsWUFBTUMsS0FBTixDQUFZbUIsZ0JBQS9CLEVBQWlEO0FBQy9DLGlCQUFPdEIsT0FBTyxDQUFDQyxNQUFSLENBQ0wsSUFBSUMsWUFBTUMsS0FBVixDQUFnQkQsWUFBTUMsS0FBTixDQUFZbUIsZ0JBQTVCLEVBQThDLGtCQUE5QyxDQURLLENBQVA7QUFHRCxTQUpELE1BSU87QUFDTCxpQkFBT3RCLE9BQU8sQ0FBQ0MsTUFBUixDQUFlSCxLQUFmLENBQVA7QUFDRDtBQUNGLE9BNUJJLENBQVA7QUE2QkQ7O0FBRUQsUUFBSVMsVUFBVSxDQUFDZ0IsU0FBZixFQUEwQjtBQUN4QixhQUFPaEIsVUFBVSxDQUFDZ0IsU0FBbEI7QUFDRDs7QUFFRCxRQUFJaEIsVUFBVSxDQUFDaUIsU0FBZixFQUEwQjtBQUN4QixhQUFPakIsVUFBVSxDQUFDaUIsU0FBbEI7QUFDRDs7QUFFRCxRQUFJakIsVUFBVSxDQUFDSyxRQUFmLEVBQXlCO0FBQ3ZCLGFBQU9ILGNBQ0pDLE1BREksQ0FFSHRCLEdBQUcsQ0FBQ0csTUFGRCxFQUdISCxHQUFHLENBQUN1QixJQUhELEVBSUh2QixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FKUixFQUtIO0FBQUV1QixRQUFBQSxRQUFRLEVBQUVMLFVBQVUsQ0FBQ0s7QUFBdkIsT0FMRyxFQU1ITCxVQU5HLEVBT0huQixHQUFHLENBQUMrQixJQUFKLENBQVNDLFNBUE4sRUFTSnZCLEtBVEksQ0FTRSxVQUFTQyxLQUFULEVBQWdCO0FBQ3JCLFlBQUlBLEtBQUssQ0FBQ3VCLElBQU4sS0FBZW5CLFlBQU1DLEtBQU4sQ0FBWW1CLGdCQUEvQixFQUFpRDtBQUMvQyxpQkFBT2IsY0FBS2dCLE1BQUwsQ0FDTHJDLEdBQUcsQ0FBQ0csTUFEQyxFQUVMSCxHQUFHLENBQUN1QixJQUZDLEVBR0x2QixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FITixFQUlMa0IsVUFKSyxFQUtMbkIsR0FBRyxDQUFDK0IsSUFBSixDQUFTQyxTQUxKLEVBTUw7QUFBRU0sWUFBQUEsYUFBYSxFQUFFO0FBQWpCLFdBTkssQ0FBUDtBQVFELFNBVEQsTUFTTztBQUNMLGlCQUFPMUIsT0FBTyxDQUFDQyxNQUFSLENBQWVILEtBQWYsQ0FBUDtBQUNEO0FBQ0YsT0F0QkksQ0FBUDtBQXVCRDs7QUFFRCxXQUFPVyxjQUFLZ0IsTUFBTCxDQUFZckMsR0FBRyxDQUFDRyxNQUFoQixFQUF3QkgsR0FBRyxDQUFDdUIsSUFBNUIsRUFBa0N2QixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FBN0MsRUFBd0RrQixVQUF4RCxDQUFQO0FBQ0Q7O0FBRURvQixFQUFBQSxjQUFjLENBQUN2QyxHQUFELEVBQU07QUFDbEIsV0FBTyxJQUFJWSxPQUFKLENBQVk0QixPQUFPLElBQUk7QUFDNUIsVUFBSUMsV0FBVyxHQUFHLEVBQWxCO0FBQ0EsVUFBSUMsVUFBSjs7QUFFQSxVQUFJO0FBQ0ZBLFFBQUFBLFVBQVUsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVc1QyxHQUFHLENBQUM2QyxJQUFKLENBQVNDLE1BQVQsQ0FBZ0JDLFFBQWhCLEVBQVgsQ0FBYjtBQUNELE9BRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDVixjQUFNLElBQUlqQyxLQUFKLENBQVUsNkNBQVYsQ0FBTjtBQUNEOztBQUVELFVBQUlrQyxLQUFLLENBQUNDLE9BQU4sQ0FBY1IsVUFBZCxDQUFKLEVBQStCO0FBQzdCRCxRQUFBQSxXQUFXLEdBQUdDLFVBQWQ7QUFDRCxPQUZELE1BRU8sSUFBSU8sS0FBSyxDQUFDQyxPQUFOLENBQWNSLFVBQVUsQ0FBQ1MsT0FBekIsQ0FBSixFQUF1QztBQUM1Q1YsUUFBQUEsV0FBVyxHQUFHQyxVQUFVLENBQUNTLE9BQXpCO0FBQ0QsT0FGTSxNQUVBLElBQUlGLEtBQUssQ0FBQ0MsT0FBTixDQUFjUixVQUFVLENBQUNVLElBQXpCLENBQUosRUFBb0M7QUFDekNYLFFBQUFBLFdBQVcsR0FBR0MsVUFBVSxDQUFDVSxJQUF6QjtBQUNEOztBQUVELFVBQUksQ0FBQ1gsV0FBTCxFQUFrQjtBQUNoQixjQUFNLElBQUkxQixLQUFKLENBQVUsbUJBQVYsQ0FBTjtBQUNEOztBQUVELFVBQUlmLEdBQUcsQ0FBQ3FELElBQUosQ0FBU0MsYUFBYixFQUE0QjtBQUMxQixZQUFJLENBQUN0RCxHQUFHLENBQUNHLE1BQUosQ0FBV29ELFlBQWhCLEVBQThCO0FBQzVCLGdCQUFNLElBQUl4QyxLQUFKLENBQVUsbUNBQVYsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUR5QixNQUFBQSxPQUFPLENBQUNDLFdBQUQsQ0FBUDtBQUNELEtBN0JNLENBQVA7QUE4QkQ7O0FBRURlLEVBQUFBLFlBQVksQ0FBQ3hELEdBQUQsRUFBTTtBQUNoQixVQUFNeUQsc0JBQXNCLEdBQUcsZ0NBQVl6RCxHQUFHLENBQUNHLE1BQUosQ0FBV29ELFlBQXZCLENBQS9CO0FBRUEsUUFBSUcsT0FBTyxHQUFHLElBQWQ7O0FBRUEsUUFBSTFELEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFBZixFQUE2QjtBQUMzQmdDLE1BQUFBLE9BQU8sR0FBRyxLQUFLM0QsWUFBTCxDQUFrQkMsR0FBbEIsRUFBdUJPLElBQXZCLENBQTRCb0QsUUFBUSxJQUFJO0FBQ2hELFlBQ0UsQ0FBQ0MsTUFBTSxDQUFDQyxTQUFQLENBQWlCQyxjQUFqQixDQUFnQ0MsSUFBaEMsQ0FDQ0osUUFBUSxDQUFDSyxNQURWLEVBRUNoRSxHQUFHLENBQUNFLE1BQUosQ0FBV3dCLFlBRlosQ0FESCxFQUtFO0FBQ0EsZ0JBQU0sSUFBSVgsS0FBSixDQUNILFlBQVdmLEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFBYSxzQkFBcUIxQixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FBVSxHQUQxRSxDQUFOO0FBR0QsU0FURCxNQVNPLElBQ0wwRCxRQUFRLENBQUNLLE1BQVQsQ0FBZ0JoRSxHQUFHLENBQUNFLE1BQUosQ0FBV3dCLFlBQTNCLEVBQXlDdUMsSUFBekMsS0FBa0QsVUFEN0MsRUFFTDtBQUNBLGdCQUFNLElBQUlsRCxLQUFKLENBQ0gsU0FDQzRDLFFBQVEsQ0FBQ0ssTUFBVCxDQUFnQmhFLEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFBM0IsRUFBeUNOLFdBQzFDLCtCQUhHLENBQU47QUFLRDs7QUFFRCxjQUFNQSxXQUFXLEdBQ2Z1QyxRQUFRLENBQUNLLE1BQVQsQ0FBZ0JoRSxHQUFHLENBQUNFLE1BQUosQ0FBV3dCLFlBQTNCLEVBQXlDTixXQUQzQztBQUdBLGVBQU9SLE9BQU8sQ0FBQ3NELEdBQVIsQ0FBWSxDQUFDLEtBQUszQixjQUFMLENBQW9CdkMsR0FBcEIsQ0FBRCxFQUEyQm9CLFdBQTNCLENBQVosQ0FBUDtBQUNELE9BeEJTLENBQVY7QUF5QkQsS0ExQkQsTUEwQk87QUFDTHNDLE1BQUFBLE9BQU8sR0FBRzlDLE9BQU8sQ0FBQ3NELEdBQVIsQ0FBWSxDQUFDLEtBQUszQixjQUFMLENBQW9CdkMsR0FBcEIsQ0FBRCxDQUFaLENBQVY7QUFDRDs7QUFFRDBELElBQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUNkbkQsSUFETyxDQUNGLENBQUMsQ0FBQ2tDLFdBQUQsRUFBY3JCLFdBQWQsQ0FBRCxLQUFnQztBQUNwQyxhQUFPcUIsV0FBVyxDQUFDMEIsTUFBWixDQUNMLENBQUNDLElBQUQsRUFBT0MsTUFBUCxFQUFlQyxLQUFmLEtBQXlCO0FBQ3ZCRixRQUFBQSxJQUFJLENBQUNHLFNBQUwsQ0FBZUMsSUFBZixDQUNFLEtBQUt0RCxnQkFBTCxDQUFzQnVELElBQXRCLENBQTJCLElBQTNCLEVBQWlDekUsR0FBakMsRUFBc0NxRSxNQUF0QyxFQUE4Q2pELFdBQTlDLENBREY7O0FBSUEsWUFDR2tELEtBQUssSUFBSUEsS0FBSyxHQUFHLEdBQVIsS0FBZ0IsQ0FBMUIsSUFDQUEsS0FBSyxLQUFLN0IsV0FBVyxDQUFDaUMsTUFBWixHQUFxQixDQUZqQyxFQUdFO0FBQ0EsZ0JBQU1ILFNBQVMsR0FBR0gsSUFBSSxDQUFDRyxTQUFMLENBQWVJLEtBQWYsQ0FBcUIsQ0FBckIsQ0FBbEI7QUFDQVAsVUFBQUEsSUFBSSxDQUFDRyxTQUFMLEdBQWlCLEVBQWpCO0FBRUFILFVBQUFBLElBQUksQ0FBQ1EsV0FBTCxHQUFtQlIsSUFBSSxDQUFDUSxXQUFMLENBQWlCckUsSUFBakIsQ0FBc0I0QyxPQUFPLElBQUk7QUFDbEQsbUJBQU92QyxPQUFPLENBQUNzRCxHQUFSLENBQ0xmLE9BQU8sQ0FBQzBCLE1BQVIsQ0FBZU4sU0FBUyxDQUFDTyxHQUFWLENBQWNDLElBQUksSUFBSUEsSUFBSSxFQUExQixDQUFmLENBREssQ0FBUDtBQUdELFdBSmtCLENBQW5CO0FBS0Q7O0FBRUQsZUFBT1gsSUFBUDtBQUNELE9BckJJLEVBc0JMO0FBQUVHLFFBQUFBLFNBQVMsRUFBRSxFQUFiO0FBQWlCSyxRQUFBQSxXQUFXLEVBQUVoRSxPQUFPLENBQUM0QixPQUFSLENBQWdCLEVBQWhCO0FBQTlCLE9BdEJLLEVBdUJMb0MsV0F2QkY7QUF3QkQsS0ExQk8sRUEyQlByRSxJQTNCTyxDQTJCRjRDLE9BQU8sSUFBSTtBQUNmLFVBQUluRCxHQUFHLENBQUNxRCxJQUFKLENBQVNDLGFBQWIsRUFBNEI7QUFDMUJHLFFBQUFBLHNCQUFzQixDQUFDdUIsUUFBdkIsQ0FBZ0M7QUFDOUJDLFVBQUFBLElBQUksRUFBRyx3REFDTGpGLEdBQUcsQ0FBQ0UsTUFBSixDQUFXRCxTQUNaLEdBQ0NELEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFBWCxHQUNJLGdCQUFnQjFCLEdBQUcsQ0FBQ0UsTUFBSixDQUFXd0IsWUFEL0IsR0FFSSxFQUNMLEdBUDZCO0FBUTlCd0QsVUFBQUEsRUFBRSxFQUFFbEYsR0FBRyxDQUFDcUQsSUFBSixDQUFTQyxhQVJpQjtBQVM5QjZCLFVBQUFBLE9BQU8sRUFBRTtBQVRxQixTQUFoQztBQVdELE9BWkQsTUFZTztBQUNMLGVBQU92RSxPQUFPLENBQUM0QixPQUFSLENBQWdCO0FBQUVtQixVQUFBQSxRQUFRLEVBQUVSO0FBQVosU0FBaEIsQ0FBUDtBQUNEO0FBQ0YsS0EzQ08sRUE0Q1AxQyxLQTVDTyxDQTRDREMsS0FBSyxJQUFJO0FBQ2QsVUFBSVYsR0FBRyxDQUFDcUQsSUFBSixDQUFTQyxhQUFiLEVBQTRCO0FBQzFCRyxRQUFBQSxzQkFBc0IsQ0FBQ3VCLFFBQXZCLENBQWdDO0FBQzlCQyxVQUFBQSxJQUFJLEVBQUcsOENBQ0xqRixHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FDWixHQUNDRCxHQUFHLENBQUNFLE1BQUosQ0FBV3dCLFlBQVgsR0FDSSxnQkFBZ0IxQixHQUFHLENBQUNFLE1BQUosQ0FBV3dCLFlBRC9CLEdBRUksRUFDTCxZQUFXaEIsS0FBTSxFQVBZO0FBUTlCd0UsVUFBQUEsRUFBRSxFQUFFbEYsR0FBRyxDQUFDcUQsSUFBSixDQUFTQyxhQVJpQjtBQVM5QjZCLFVBQUFBLE9BQU8sRUFBRTtBQVRxQixTQUFoQztBQVdELE9BWkQsTUFZTztBQUNMLGNBQU0sSUFBSXBFLEtBQUosQ0FBVSw0QkFBNEJMLEtBQXRDLENBQU47QUFDRDtBQUNGLEtBNURPLENBQVY7O0FBOERBLFFBQUlWLEdBQUcsQ0FBQ3FELElBQUosQ0FBU0MsYUFBVCxJQUEwQkcsc0JBQTlCLEVBQXNEO0FBQ3BEQyxNQUFBQSxPQUFPLEdBQUc5QyxPQUFPLENBQUM0QixPQUFSLENBQWdCO0FBQ3hCbUIsUUFBQUEsUUFBUSxFQUNOO0FBRnNCLE9BQWhCLENBQVY7QUFJRDs7QUFFRCxXQUFPRCxPQUFQO0FBQ0Q7O0FBRUQwQixFQUFBQSxrQkFBa0IsQ0FBQ3BGLEdBQUQsRUFBTXFGLEdBQU4sRUFBV0MsT0FBWCxFQUFvQjtBQUNwQyxXQUFPQSxPQUFPLENBQUN0RixHQUFELENBQVAsQ0FDSk8sSUFESSxDQUNDZ0YsSUFBSSxJQUFJO0FBQ1pGLE1BQUFBLEdBQUcsQ0FBQ0csSUFBSixDQUFTRCxJQUFUO0FBQ0QsS0FISSxFQUlKOUUsS0FKSSxDQUlFZ0YsR0FBRyxJQUFJO0FBQ1pKLE1BQUFBLEdBQUcsQ0FBQ0ssTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVDLFFBQUFBLE9BQU8sRUFBRUgsR0FBRyxDQUFDRztBQUFmLE9BQXJCO0FBQ0QsS0FOSSxDQUFQO0FBT0Q7O0FBRURDLEVBQUFBLGFBQWEsR0FBRztBQUNkLFVBQU1DLE1BQU0sR0FBR0MsaUJBQVFDLE1BQVIsRUFBZjs7QUFDQSxVQUFNQyxNQUFNLEdBQUcsc0JBQWY7QUFFQUgsSUFBQUEsTUFBTSxDQUFDSSxJQUFQLENBQ0UseUJBREYsRUFFRUQsTUFBTSxDQUFDRSxNQUFQLENBQWMsWUFBZCxDQUZGLEVBR0U7QUFDQUMsSUFBQUEsV0FBVyxDQUFDQyxrQkFKZCxFQUtFRCxXQUFXLENBQUNFLHNCQUxkLEVBTUUsQ0FBQ3RHLEdBQUQsRUFBTXFGLEdBQU4sS0FDRSxLQUFLRCxrQkFBTCxDQUF3QnBGLEdBQXhCLEVBQTZCcUYsR0FBN0IsRUFBa0MsS0FBSzdCLFlBQUwsQ0FBa0JpQixJQUFsQixDQUF1QixJQUF2QixDQUFsQyxDQVBKO0FBVUFxQixJQUFBQSxNQUFNLENBQUNJLElBQVAsQ0FDRSxnREFERixFQUVFRCxNQUFNLENBQUNFLE1BQVAsQ0FBYyxZQUFkLENBRkYsRUFHRTtBQUNBQyxJQUFBQSxXQUFXLENBQUNDLGtCQUpkLEVBS0VELFdBQVcsQ0FBQ0Usc0JBTGQsRUFNRSxDQUFDdEcsR0FBRCxFQUFNcUYsR0FBTixLQUNFLEtBQUtELGtCQUFMLENBQXdCcEYsR0FBeEIsRUFBNkJxRixHQUE3QixFQUFrQyxLQUFLN0IsWUFBTCxDQUFrQmlCLElBQWxCLENBQXVCLElBQXZCLENBQWxDLENBUEo7QUFVQSxXQUFPcUIsTUFBUDtBQUNEOztBQS9RdUI7OztlQWtSWGhHLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGxvYWRBZGFwdGVyIH0gZnJvbSAnLi4vQWRhcHRlcnMvQWRhcHRlckxvYWRlcic7XG5pbXBvcnQgKiBhcyBtaWRkbGV3YXJlcyBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgbXVsdGVyIGZyb20gJ211bHRlcic7XG5pbXBvcnQgcmVzdCBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IFBhcnNlIH0gZnJvbSAncGFyc2Uvbm9kZSc7XG5cbmV4cG9ydCBjbGFzcyBJbXBvcnRSb3V0ZXIge1xuICBnZXRPbmVTY2hlbWEocmVxKSB7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gcmVxLnBhcmFtcy5jbGFzc05hbWU7XG5cbiAgICByZXR1cm4gcmVxLmNvbmZpZy5kYXRhYmFzZVxuICAgICAgLmxvYWRTY2hlbWEoeyBjbGVhckNhY2hlOiB0cnVlIH0pXG4gICAgICAudGhlbihzY2hlbWFDb250cm9sbGVyID0+IHNjaGVtYUNvbnRyb2xsZXIuZ2V0T25lU2NoZW1hKGNsYXNzTmFtZSkpXG4gICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICBpZiAoZXJyb3IgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcbiAgICAgICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICAgICAgUGFyc2UuRXJyb3IuSU5WQUxJRF9DTEFTU19OQU1FLFxuICAgICAgICAgICAgICBgQ2xhc3MgJHtjbGFzc05hbWV9IGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcbiAgICAgICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICAgICAgUGFyc2UuRXJyb3IuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgICAgICAgICAnRGF0YWJhc2UgYWRhcHRlciBlcnJvci4nXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBpbXBvcnRSZXN0T2JqZWN0KHJlcSwgcmVzdE9iamVjdCwgdGFyZ2V0Q2xhc3MpIHtcbiAgICBpZiAodGFyZ2V0Q2xhc3MpIHtcbiAgICAgIHJldHVybiByZXN0XG4gICAgICAgIC51cGRhdGUoXG4gICAgICAgICAgcmVxLmNvbmZpZyxcbiAgICAgICAgICByZXEuYXV0aCxcbiAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZSxcbiAgICAgICAgICB7IG9iamVjdElkOiByZXN0T2JqZWN0Lm93bmluZ0lkIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXToge1xuICAgICAgICAgICAgICBfX29wOiAnQWRkUmVsYXRpb24nLFxuICAgICAgICAgICAgICBvYmplY3RzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgX190eXBlOiAnUG9pbnRlcicsXG4gICAgICAgICAgICAgICAgICBjbGFzc05hbWU6IHRhcmdldENsYXNzLFxuICAgICAgICAgICAgICAgICAgb2JqZWN0SWQ6IHJlc3RPYmplY3QucmVsYXRlZElkLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVxLmluZm8uY2xpZW50U0RLXG4gICAgICAgIClcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09IFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcbiAgICAgICAgICAgICAgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kJylcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocmVzdE9iamVjdC5jcmVhdGVkQXQpIHtcbiAgICAgIGRlbGV0ZSByZXN0T2JqZWN0LmNyZWF0ZWRBdDtcbiAgICB9XG5cbiAgICBpZiAocmVzdE9iamVjdC51cGRhdGVkQXQpIHtcbiAgICAgIGRlbGV0ZSByZXN0T2JqZWN0LnVwZGF0ZWRBdDtcbiAgICB9XG5cbiAgICBpZiAocmVzdE9iamVjdC5vYmplY3RJZCkge1xuICAgICAgcmV0dXJuIHJlc3RcbiAgICAgICAgLnVwZGF0ZShcbiAgICAgICAgICByZXEuY29uZmlnLFxuICAgICAgICAgIHJlcS5hdXRoLFxuICAgICAgICAgIHJlcS5wYXJhbXMuY2xhc3NOYW1lLFxuICAgICAgICAgIHsgb2JqZWN0SWQ6IHJlc3RPYmplY3Qub2JqZWN0SWQgfSxcbiAgICAgICAgICByZXN0T2JqZWN0LFxuICAgICAgICAgIHJlcS5pbmZvLmNsaWVudFNES1xuICAgICAgICApXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdC5jcmVhdGUoXG4gICAgICAgICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgICAgICAgIHJlcS5hdXRoLFxuICAgICAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgcmVzdE9iamVjdCxcbiAgICAgICAgICAgICAgcmVxLmluZm8uY2xpZW50U0RLLFxuICAgICAgICAgICAgICB7IGFsbG93T2JqZWN0SWQ6IHRydWUgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZXN0LmNyZWF0ZShyZXEuY29uZmlnLCByZXEuYXV0aCwgcmVxLnBhcmFtcy5jbGFzc05hbWUsIHJlc3RPYmplY3QpO1xuICB9XG5cbiAgZ2V0UmVzdE9iamVjdHMocmVxKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgbGV0IHJlc3RPYmplY3RzID0gW107XG4gICAgICBsZXQgaW1wb3J0RmlsZTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaW1wb3J0RmlsZSA9IEpTT04ucGFyc2UocmVxLmZpbGUuYnVmZmVyLnRvU3RyaW5nKCkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBKU09OIGJhc2VkIG9uIHRoZSBmaWxlIHNlbnQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaW1wb3J0RmlsZSkpIHtcbiAgICAgICAgcmVzdE9iamVjdHMgPSBpbXBvcnRGaWxlO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGltcG9ydEZpbGUucmVzdWx0cykpIHtcbiAgICAgICAgcmVzdE9iamVjdHMgPSBpbXBvcnRGaWxlLnJlc3VsdHM7XG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaW1wb3J0RmlsZS5yb3dzKSkge1xuICAgICAgICByZXN0T2JqZWN0cyA9IGltcG9ydEZpbGUucm93cztcbiAgICAgIH1cblxuICAgICAgaWYgKCFyZXN0T2JqZWN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGRhdGEgdG8gaW1wb3J0Jyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsKSB7XG4gICAgICAgIGlmICghcmVxLmNvbmZpZy5lbWFpbEFkYXB0ZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBoYXZlIHRvIHNldHVwIGEgTWFpbCBBZGFwdGVyLicpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlc29sdmUocmVzdE9iamVjdHMpO1xuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlSW1wb3J0KHJlcSkge1xuICAgIGNvbnN0IGVtYWlsQ29udHJvbGxlckFkYXB0ZXIgPSBsb2FkQWRhcHRlcihyZXEuY29uZmlnLmVtYWlsQWRhcHRlcik7XG5cbiAgICBsZXQgcHJvbWlzZSA9IG51bGw7XG5cbiAgICBpZiAocmVxLnBhcmFtcy5yZWxhdGlvbk5hbWUpIHtcbiAgICAgIHByb21pc2UgPSB0aGlzLmdldE9uZVNjaGVtYShyZXEpLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChcbiAgICAgICAgICAgIHJlc3BvbnNlLmZpZWxkcyxcbiAgICAgICAgICAgIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgUmVsYXRpb24gJHtyZXEucGFyYW1zLnJlbGF0aW9uTmFtZX0gZG9lcyBub3QgZXhpc3QgaW4gJHtyZXEucGFyYW1zLmNsYXNzTmFtZX0uYFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgcmVzcG9uc2UuZmllbGRzW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXS50eXBlICE9PSAnUmVsYXRpb24nXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDbGFzcyAke1xuICAgICAgICAgICAgICByZXNwb25zZS5maWVsZHNbcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVdLnRhcmdldENsYXNzXG4gICAgICAgICAgICB9IGRvZXMgbm90IGhhdmUgUmVsYXRpb24gdHlwZS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRhcmdldENsYXNzID1cbiAgICAgICAgICByZXNwb25zZS5maWVsZHNbcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVdLnRhcmdldENsYXNzO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbdGhpcy5nZXRSZXN0T2JqZWN0cyhyZXEpLCB0YXJnZXRDbGFzc10pO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb21pc2UgPSBQcm9taXNlLmFsbChbdGhpcy5nZXRSZXN0T2JqZWN0cyhyZXEpXSk7XG4gICAgfVxuXG4gICAgcHJvbWlzZSA9IHByb21pc2VcbiAgICAgIC50aGVuKChbcmVzdE9iamVjdHMsIHRhcmdldENsYXNzXSkgPT4ge1xuICAgICAgICByZXR1cm4gcmVzdE9iamVjdHMucmVkdWNlKFxuICAgICAgICAgIChpdGVtLCBvYmplY3QsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBpdGVtLnBhZ2VBcnJheS5wdXNoKFxuICAgICAgICAgICAgICB0aGlzLmltcG9ydFJlc3RPYmplY3QuYmluZCh0aGlzLCByZXEsIG9iamVjdCwgdGFyZ2V0Q2xhc3MpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIChpbmRleCAmJiBpbmRleCAlIDEwMCA9PT0gMCkgfHxcbiAgICAgICAgICAgICAgaW5kZXggPT09IHJlc3RPYmplY3RzLmxlbmd0aCAtIDFcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBjb25zdCBwYWdlQXJyYXkgPSBpdGVtLnBhZ2VBcnJheS5zbGljZSgwKTtcbiAgICAgICAgICAgICAgaXRlbS5wYWdlQXJyYXkgPSBbXTtcblxuICAgICAgICAgICAgICBpdGVtLm1haW5Qcm9taXNlID0gaXRlbS5tYWluUHJvbWlzZS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY29uY2F0KHBhZ2VBcnJheS5tYXAoZnVuYyA9PiBmdW5jKCkpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHsgcGFnZUFycmF5OiBbXSwgbWFpblByb21pc2U6IFByb21pc2UucmVzb2x2ZShbXSkgfVxuICAgICAgICApLm1haW5Qcm9taXNlO1xuICAgICAgfSlcbiAgICAgIC50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICBpZiAocmVxLmJvZHkuZmVlZGJhY2tFbWFpbCkge1xuICAgICAgICAgIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgICAgdGV4dDogYFdlIGhhdmUgc3VjY2Vzc2Z1bGx5IGltcG9ydGVkIHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtcbiAgICAgICAgICAgICAgcmVxLnBhcmFtcy5jbGFzc05hbWVcbiAgICAgICAgICAgIH0ke1xuICAgICAgICAgICAgICByZXEucGFyYW1zLnJlbGF0aW9uTmFtZVxuICAgICAgICAgICAgICAgID8gJywgcmVsYXRpb24gJyArIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lXG4gICAgICAgICAgICAgICAgOiAnJ1xuICAgICAgICAgICAgfS5gLFxuICAgICAgICAgICAgdG86IHJlcS5ib2R5LmZlZWRiYWNrRW1haWwsXG4gICAgICAgICAgICBzdWJqZWN0OiAnSW1wb3J0IGNvbXBsZXRlZCcsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlc3BvbnNlOiByZXN1bHRzIH0pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgaWYgKHJlcS5ib2R5LmZlZWRiYWNrRW1haWwpIHtcbiAgICAgICAgICBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICAgIHRleHQ6IGBXZSBjb3VsZCBub3QgaW1wb3J0IHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtcbiAgICAgICAgICAgICAgcmVxLnBhcmFtcy5jbGFzc05hbWVcbiAgICAgICAgICAgIH0ke1xuICAgICAgICAgICAgICByZXEucGFyYW1zLnJlbGF0aW9uTmFtZVxuICAgICAgICAgICAgICAgID8gJywgcmVsYXRpb24gJyArIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lXG4gICAgICAgICAgICAgICAgOiAnJ1xuICAgICAgICAgICAgfS4gRXJyb3I6ICR7ZXJyb3J9YCxcbiAgICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgICAgc3ViamVjdDogJ0ltcG9ydCBmYWlsZWQnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW50ZXJuYWwgc2VydmVyIGVycm9yOiAnICsgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsICYmIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIpIHtcbiAgICAgIHByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICByZXNwb25zZTpcbiAgICAgICAgICAnV2UgYXJlIGltcG9ydGluZyB5b3VyIGRhdGEuIFlvdSB3aWxsIGJlIG5vdGlmaWVkIGJ5IGUtbWFpbCBvbmNlIGl0IGlzIGNvbXBsZXRlZC4nLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuICB3cmFwUHJvbWlzZVJlcXVlc3QocmVxLCByZXMsIGhhbmRsZXIpIHtcbiAgICByZXR1cm4gaGFuZGxlcihyZXEpXG4gICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgcmVzLmpzb24oZGF0YSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHsgbWVzc2FnZTogZXJyLm1lc3NhZ2UgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGV4cHJlc3NSb3V0ZXIoKSB7XG4gICAgY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbiAgICBjb25zdCB1cGxvYWQgPSBtdWx0ZXIoKTtcblxuICAgIHJvdXRlci5wb3N0KFxuICAgICAgJy9pbXBvcnRfZGF0YS86Y2xhc3NOYW1lJyxcbiAgICAgIHVwbG9hZC5zaW5nbGUoJ2ltcG9ydEZpbGUnKSxcbiAgICAgIC8vIG1pZGRsZXdhcmVzLmFsbG93Q3Jvc3NEb21haW4sXG4gICAgICBtaWRkbGV3YXJlcy5oYW5kbGVQYXJzZUhlYWRlcnMsXG4gICAgICBtaWRkbGV3YXJlcy5lbmZvcmNlTWFzdGVyS2V5QWNjZXNzLFxuICAgICAgKHJlcSwgcmVzKSA9PlxuICAgICAgICB0aGlzLndyYXBQcm9taXNlUmVxdWVzdChyZXEsIHJlcywgdGhpcy5oYW5kbGVJbXBvcnQuYmluZCh0aGlzKSlcbiAgICApO1xuXG4gICAgcm91dGVyLnBvc3QoXG4gICAgICAnL2ltcG9ydF9yZWxhdGlvbl9kYXRhLzpjbGFzc05hbWUvOnJlbGF0aW9uTmFtZScsXG4gICAgICB1cGxvYWQuc2luZ2xlKCdpbXBvcnRGaWxlJyksXG4gICAgICAvLyBtaWRkbGV3YXJlcy5hbGxvd0Nyb3NzRG9tYWluLFxuICAgICAgbWlkZGxld2FyZXMuaGFuZGxlUGFyc2VIZWFkZXJzLFxuICAgICAgbWlkZGxld2FyZXMuZW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgICAgIChyZXEsIHJlcykgPT5cbiAgICAgICAgdGhpcy53cmFwUHJvbWlzZVJlcXVlc3QocmVxLCByZXMsIHRoaXMuaGFuZGxlSW1wb3J0LmJpbmQodGhpcykpXG4gICAgKTtcblxuICAgIHJldHVybiByb3V0ZXI7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSW1wb3J0Um91dGVyO1xuIl19