"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExportRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var _rest = _interopRequireDefault(require("../rest"));

var _archiver = _interopRequireDefault(require("archiver"));

var _tmp = _interopRequireDefault(require("tmp"));

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DefaultExportExportProgressCollectionName = '_ExportProgress';
const relationSchema = {
  fields: {
    relatedId: {
      type: 'String'
    },
    owningId: {
      type: 'String'
    }
  }
};

class ExportRouter extends _PromiseRouter.default {
  exportClassPage(req, className, jsonFileStream, where, skip, limit) {
    const databaseController = req.config.database;
    const options = {
      skip,
      limit
    };
    let findPromise;

    if (className.indexOf('_Join') === 0) {
      findPromise = databaseController.adapter.find(className, relationSchema, where, options);
    } else {
      findPromise = _rest.default.find(req.config, req.auth, className, where, options);
    }

    return findPromise.then(data => {
      if (Array.isArray(data)) {
        data = {
          results: data.map(obj => {
            // Needed to avoid errors during import.
            // See more: https://docs.parseplatform.org/js/guide/#error-codes
            // Deletes invalid keys in order to avoid "ParseError: 105 Invalid field name"
            // when importing
            Object.keys(obj).forEach(key => {
              if (key.startsWith('_')) {
                delete obj[key];
              }
            });
            return obj;
          })
        };
      }

      if (skip && data.results.length) {
        jsonFileStream.write(',\n');
      }

      jsonFileStream.write(JSON.stringify(data.results, null, 2).substr(1).slice(0, -1));
    });
  }

  exportClass(req, data) {
    const databaseController = req.config.database;

    const tmpJsonFile = _tmp.default.fileSync();

    const jsonFileStream = _fs.default.createWriteStream(tmpJsonFile.name);

    jsonFileStream.write('{\n"results" : [\n');
    const hasJoin = data.name.indexOf('_Join') === 0;
    let findPromise = null;

    if (hasJoin) {
      findPromise = databaseController.adapter.count(data.name, relationSchema, data.where);
    } else {
      findPromise = _rest.default.find(req.config, req.auth, data.name, data.where, {
        count: true,
        limit: 0
      });
    }

    return findPromise.then(result => {
      if (Number.isInteger(result)) {
        result = {
          count: result
        };
      }

      let i = 0;
      const pageLimit = 1000;
      let promise = Promise.resolve();

      for (i = 0; i < result.count; i += pageLimit) {
        const skip = i;
        promise = promise.then(() => {
          return this.exportClassPage(req, data.name, jsonFileStream, data.where, skip, pageLimit);
        });
      }

      return promise;
    }).then(() => {
      jsonFileStream.end(']\n}');
      return new Promise(resolve => {
        jsonFileStream.on('close', () => {
          tmpJsonFile._name = `${data.name.replace(/:/g, 'êž‰')}.json`;
          resolve(tmpJsonFile);
        });
      });
    });
  }

  handleExportProgress(req) {
    const databaseController = req.config.database;
    const query = {
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    return databaseController.find(DefaultExportExportProgressCollectionName, query).then(response => {
      return {
        response
      };
    });
  }

  handleExport(req) {
    const databaseController = req.config.database;
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);

    if (!emailControllerAdapter) {
      return Promise.reject(new Error('You have to setup a Mail Adapter.'));
    }

    const exportProgress = {
      id: req.body.name,
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    databaseController.create(DefaultExportExportProgressCollectionName, exportProgress).then(() => {
      return databaseController.loadSchema({
        clearCache: true
      });
    }).then(schemaController => schemaController.getOneSchema(req.body.name, true)).then(schema => {
      const classNames = [req.body.name];
      Object.keys(schema.fields).forEach(fieldName => {
        const field = schema.fields[fieldName];

        if (field.type === 'Relation') {
          classNames.push(`_Join:${fieldName}:${req.body.name}`);
        }
      });
      const promisses = classNames.map(name => {
        return this.exportClass(req, {
          name
        });
      });
      return Promise.all(promisses);
    }).then(jsonFiles => {
      return new Promise(resolve => {
        const tmpZipFile = _tmp.default.fileSync();

        const tmpZipStream = _fs.default.createWriteStream(tmpZipFile.name);

        const zip = (0, _archiver.default)('zip');
        zip.pipe(tmpZipStream);
        jsonFiles.forEach(tmpJsonFile => {
          zip.append(_fs.default.readFileSync(tmpJsonFile.name), {
            name: tmpJsonFile._name
          });
          tmpJsonFile.removeCallback();
        });
        zip.finalize();
        tmpZipStream.on('close', () => {
          const buf = _fs.default.readFileSync(tmpZipFile.name);

          tmpZipFile.removeCallback();
          resolve(buf);
        });
      });
    }).then(zippedFile => {
      const filesController = req.config.filesController;
      return filesController.createFile(req.config, req.body.name, zippedFile, 'application/zip');
    }).then(fileData => {
      return emailControllerAdapter.sendMail({
        text: `We have successfully exported your data from the class ${req.body.name}.\n
        Please download from ${fileData.url}`,
        link: fileData.url,
        to: req.body.feedbackEmail,
        subject: 'Export completed'
      });
    }).catch(error => {
      return emailControllerAdapter.sendMail({
        text: `We could not export your data to the class ${req.body.name}. Error: ${error}`,
        to: req.body.feedbackEmail,
        subject: 'Export failed'
      });
    }).then(() => {
      return databaseController.destroy(DefaultExportExportProgressCollectionName, exportProgress);
    });
    return Promise.resolve({
      response: 'We are exporting your data. You will be notified by e-mail once it is completed.'
    });
  }

  mountRoutes() {
    this.route('PUT', '/export_data', req => {
      return this.handleExport(req);
    });
    this.route('GET', '/export_progress', req => {
      return this.handleExportProgress(req);
    });
  }

}

exports.ExportRouter = ExportRouter;
var _default = ExportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0V4cG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSIsInJlbGF0aW9uU2NoZW1hIiwiZmllbGRzIiwicmVsYXRlZElkIiwidHlwZSIsIm93bmluZ0lkIiwiRXhwb3J0Um91dGVyIiwiUHJvbWlzZVJvdXRlciIsImV4cG9ydENsYXNzUGFnZSIsInJlcSIsImNsYXNzTmFtZSIsImpzb25GaWxlU3RyZWFtIiwid2hlcmUiLCJza2lwIiwibGltaXQiLCJkYXRhYmFzZUNvbnRyb2xsZXIiLCJjb25maWciLCJkYXRhYmFzZSIsIm9wdGlvbnMiLCJmaW5kUHJvbWlzZSIsImluZGV4T2YiLCJhZGFwdGVyIiwiZmluZCIsInJlc3QiLCJhdXRoIiwidGhlbiIsImRhdGEiLCJBcnJheSIsImlzQXJyYXkiLCJyZXN1bHRzIiwibWFwIiwib2JqIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJzdGFydHNXaXRoIiwibGVuZ3RoIiwid3JpdGUiLCJKU09OIiwic3RyaW5naWZ5Iiwic3Vic3RyIiwic2xpY2UiLCJleHBvcnRDbGFzcyIsInRtcEpzb25GaWxlIiwidG1wIiwiZmlsZVN5bmMiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwibmFtZSIsImhhc0pvaW4iLCJjb3VudCIsInJlc3VsdCIsIk51bWJlciIsImlzSW50ZWdlciIsImkiLCJwYWdlTGltaXQiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJlbmQiLCJvbiIsIl9uYW1lIiwicmVwbGFjZSIsImhhbmRsZUV4cG9ydFByb2dyZXNzIiwicXVlcnkiLCJtYXN0ZXJLZXkiLCJpbmZvIiwiYXBwbGljYXRpb25JZCIsImFwcElkIiwicmVzcG9uc2UiLCJoYW5kbGVFeHBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwiZW1haWxBZGFwdGVyIiwicmVqZWN0IiwiRXJyb3IiLCJleHBvcnRQcm9ncmVzcyIsImlkIiwiYm9keSIsImNyZWF0ZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwic2NoZW1hQ29udHJvbGxlciIsImdldE9uZVNjaGVtYSIsInNjaGVtYSIsImNsYXNzTmFtZXMiLCJmaWVsZE5hbWUiLCJmaWVsZCIsInB1c2giLCJwcm9taXNzZXMiLCJhbGwiLCJqc29uRmlsZXMiLCJ0bXBaaXBGaWxlIiwidG1wWmlwU3RyZWFtIiwiemlwIiwicGlwZSIsImFwcGVuZCIsInJlYWRGaWxlU3luYyIsInJlbW92ZUNhbGxiYWNrIiwiZmluYWxpemUiLCJidWYiLCJ6aXBwZWRGaWxlIiwiZmlsZXNDb250cm9sbGVyIiwiY3JlYXRlRmlsZSIsImZpbGVEYXRhIiwic2VuZE1haWwiLCJ0ZXh0IiwidXJsIiwibGluayIsInRvIiwiZmVlZGJhY2tFbWFpbCIsInN1YmplY3QiLCJjYXRjaCIsImVycm9yIiwiZGVzdHJveSIsIm1vdW50Um91dGVzIiwicm91dGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLHlDQUF5QyxHQUFHLGlCQUFsRDtBQUNBLE1BQU1DLGNBQWMsR0FBRztBQUNyQkMsRUFBQUEsTUFBTSxFQUFFO0FBQUVDLElBQUFBLFNBQVMsRUFBRTtBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFiO0FBQWlDQyxJQUFBQSxRQUFRLEVBQUU7QUFBRUQsTUFBQUEsSUFBSSxFQUFFO0FBQVI7QUFBM0M7QUFEYSxDQUF2Qjs7QUFJTyxNQUFNRSxZQUFOLFNBQTJCQyxzQkFBM0IsQ0FBeUM7QUFDOUNDLEVBQUFBLGVBQWUsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCQyxjQUFqQixFQUFpQ0MsS0FBakMsRUFBd0NDLElBQXhDLEVBQThDQyxLQUE5QyxFQUFxRDtBQUNsRSxVQUFNQyxrQkFBa0IsR0FBR04sR0FBRyxDQUFDTyxNQUFKLENBQVdDLFFBQXRDO0FBRUEsVUFBTUMsT0FBTyxHQUFHO0FBQ2RM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RkQ7QUFHRDs7QUE1TzZDOzs7ZUErT2pDSCxZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgeyBsb2FkQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL0FkYXB0ZXJMb2FkZXInO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi4vcmVzdCc7XG5pbXBvcnQgYXJjaGl2ZXIgZnJvbSAnYXJjaGl2ZXInO1xuaW1wb3J0IHRtcCBmcm9tICd0bXAnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcblxuY29uc3QgRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUgPSAnX0V4cG9ydFByb2dyZXNzJztcbmNvbnN0IHJlbGF0aW9uU2NoZW1hID0ge1xuICBmaWVsZHM6IHsgcmVsYXRlZElkOiB7IHR5cGU6ICdTdHJpbmcnIH0sIG93bmluZ0lkOiB7IHR5cGU6ICdTdHJpbmcnIH0gfSxcbn07XG5cbmV4cG9ydCBjbGFzcyBFeHBvcnRSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgZXhwb3J0Q2xhc3NQYWdlKHJlcSwgY2xhc3NOYW1lLCBqc29uRmlsZVN0cmVhbSwgd2hlcmUsIHNraXAsIGxpbWl0KSB7XG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXQsXG4gICAgfTtcblxuICAgIGxldCBmaW5kUHJvbWlzZTtcbiAgICBpZiAoY2xhc3NOYW1lLmluZGV4T2YoJ19Kb2luJykgPT09IDApIHtcbiAgICAgIGZpbmRQcm9taXNlID0gZGF0YWJhc2VDb250cm9sbGVyLmFkYXB0ZXIuZmluZChcbiAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICByZWxhdGlvblNjaGVtYSxcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIG9wdGlvbnNcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbmRQcm9taXNlID0gcmVzdC5maW5kKHJlcS5jb25maWcsIHJlcS5hdXRoLCBjbGFzc05hbWUsIHdoZXJlLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmluZFByb21pc2UudGhlbihkYXRhID0+IHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgIGRhdGEgPSB7XG4gICAgICAgICAgcmVzdWx0czogZGF0YS5tYXAob2JqID0+IHtcbiAgICAgICAgICAgIC8vIE5lZWRlZCB0byBhdm9pZCBlcnJvcnMgZHVyaW5nIGltcG9ydC5cbiAgICAgICAgICAgIC8vIFNlZSBtb3JlOiBodHRwczovL2RvY3MucGFyc2VwbGF0Zm9ybS5vcmcvanMvZ3VpZGUvI2Vycm9yLWNvZGVzXG5cbiAgICAgICAgICAgIC8vIERlbGV0ZXMgaW52YWxpZCBrZXlzIGluIG9yZGVyIHRvIGF2b2lkIFwiUGFyc2VFcnJvcjogMTA1IEludmFsaWQgZmllbGQgbmFtZVwiXG4gICAgICAgICAgICAvLyB3aGVuIGltcG9ydGluZ1xuICAgICAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnXycpKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9ialtrZXldO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChza2lwICYmIGRhdGEucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAganNvbkZpbGVTdHJlYW0ud3JpdGUoJyxcXG4nKTtcbiAgICAgIH1cblxuICAgICAganNvbkZpbGVTdHJlYW0ud3JpdGUoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KGRhdGEucmVzdWx0cywgbnVsbCwgMilcbiAgICAgICAgICAuc3Vic3RyKDEpXG4gICAgICAgICAgLnNsaWNlKDAsIC0xKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGV4cG9ydENsYXNzKHJlcSwgZGF0YSkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG4gICAgY29uc3QgdG1wSnNvbkZpbGUgPSB0bXAuZmlsZVN5bmMoKTtcbiAgICBjb25zdCBqc29uRmlsZVN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRtcEpzb25GaWxlLm5hbWUpO1xuXG4gICAganNvbkZpbGVTdHJlYW0ud3JpdGUoJ3tcXG5cInJlc3VsdHNcIiA6IFtcXG4nKTtcbiAgICBjb25zdCBoYXNKb2luID0gZGF0YS5uYW1lLmluZGV4T2YoJ19Kb2luJykgPT09IDA7XG4gICAgbGV0IGZpbmRQcm9taXNlID0gbnVsbDtcbiAgICBpZiAoaGFzSm9pbikge1xuICAgICAgZmluZFByb21pc2UgPSBkYXRhYmFzZUNvbnRyb2xsZXIuYWRhcHRlci5jb3VudChcbiAgICAgICAgZGF0YS5uYW1lLFxuICAgICAgICByZWxhdGlvblNjaGVtYSxcbiAgICAgICAgZGF0YS53aGVyZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmluZFByb21pc2UgPSByZXN0LmZpbmQocmVxLmNvbmZpZywgcmVxLmF1dGgsIGRhdGEubmFtZSwgZGF0YS53aGVyZSwge1xuICAgICAgICBjb3VudDogdHJ1ZSxcbiAgICAgICAgbGltaXQ6IDAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmluZFByb21pc2VcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHJlc3VsdCkpIHtcbiAgICAgICAgICByZXN1bHQgPSB7IGNvdW50OiByZXN1bHQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgY29uc3QgcGFnZUxpbWl0ID0gMTAwMDtcbiAgICAgICAgbGV0IHByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVzdWx0LmNvdW50OyBpICs9IHBhZ2VMaW1pdCkge1xuICAgICAgICAgIGNvbnN0IHNraXAgPSBpO1xuICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0Q2xhc3NQYWdlKFxuICAgICAgICAgICAgICByZXEsXG4gICAgICAgICAgICAgIGRhdGEubmFtZSxcbiAgICAgICAgICAgICAganNvbkZpbGVTdHJlYW0sXG4gICAgICAgICAgICAgIGRhdGEud2hlcmUsXG4gICAgICAgICAgICAgIHNraXAsXG4gICAgICAgICAgICAgIHBhZ2VMaW1pdFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAganNvbkZpbGVTdHJlYW0uZW5kKCddXFxufScpO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICBqc29uRmlsZVN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICB0bXBKc29uRmlsZS5fbmFtZSA9IGAke2RhdGEubmFtZS5yZXBsYWNlKC86L2csICfqnoknKX0uanNvbmA7XG5cbiAgICAgICAgICAgIHJlc29sdmUodG1wSnNvbkZpbGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRXhwb3J0UHJvZ3Jlc3MocmVxKSB7XG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IHF1ZXJ5ID0ge1xuICAgICAgbWFzdGVyS2V5OiByZXEuaW5mby5tYXN0ZXJLZXksXG4gICAgICBhcHBsaWNhdGlvbklkOiByZXEuaW5mby5hcHBJZCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlclxuICAgICAgLmZpbmQoRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUsIHF1ZXJ5KVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICByZXR1cm4geyByZXNwb25zZSB9O1xuICAgICAgfSk7XG4gIH1cblxuICBoYW5kbGVFeHBvcnQocmVxKSB7XG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IGVtYWlsQ29udHJvbGxlckFkYXB0ZXIgPSBsb2FkQWRhcHRlcihyZXEuY29uZmlnLmVtYWlsQWRhcHRlcik7XG5cbiAgICBpZiAoIWVtYWlsQ29udHJvbGxlckFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1lvdSBoYXZlIHRvIHNldHVwIGEgTWFpbCBBZGFwdGVyLicpKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHBvcnRQcm9ncmVzcyA9IHtcbiAgICAgIGlkOiByZXEuYm9keS5uYW1lLFxuICAgICAgbWFzdGVyS2V5OiByZXEuaW5mby5tYXN0ZXJLZXksXG4gICAgICBhcHBsaWNhdGlvbklkOiByZXEuaW5mby5hcHBJZCxcbiAgICB9O1xuXG4gICAgZGF0YWJhc2VDb250cm9sbGVyXG4gICAgICAuY3JlYXRlKERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLCBleHBvcnRQcm9ncmVzcylcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZSB9KTtcbiAgICAgIH0pXG4gICAgICAudGhlbihzY2hlbWFDb250cm9sbGVyID0+XG4gICAgICAgIHNjaGVtYUNvbnRyb2xsZXIuZ2V0T25lU2NoZW1hKHJlcS5ib2R5Lm5hbWUsIHRydWUpXG4gICAgICApXG4gICAgICAudGhlbihzY2hlbWEgPT4ge1xuICAgICAgICBjb25zdCBjbGFzc05hbWVzID0gW3JlcS5ib2R5Lm5hbWVdO1xuICAgICAgICBPYmplY3Qua2V5cyhzY2hlbWEuZmllbGRzKS5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSBzY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG5cbiAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ1JlbGF0aW9uJykge1xuICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKGBfSm9pbjoke2ZpZWxkTmFtZX06JHtyZXEuYm9keS5uYW1lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzc2VzID0gY2xhc3NOYW1lcy5tYXAobmFtZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0Q2xhc3MocmVxLCB7IG5hbWUgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNzZXMpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGpzb25GaWxlcyA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICBjb25zdCB0bXBaaXBGaWxlID0gdG1wLmZpbGVTeW5jKCk7XG4gICAgICAgICAgY29uc3QgdG1wWmlwU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0odG1wWmlwRmlsZS5uYW1lKTtcblxuICAgICAgICAgIGNvbnN0IHppcCA9IGFyY2hpdmVyKCd6aXAnKTtcbiAgICAgICAgICB6aXAucGlwZSh0bXBaaXBTdHJlYW0pO1xuXG4gICAgICAgICAganNvbkZpbGVzLmZvckVhY2godG1wSnNvbkZpbGUgPT4ge1xuICAgICAgICAgICAgemlwLmFwcGVuZChmcy5yZWFkRmlsZVN5bmModG1wSnNvbkZpbGUubmFtZSksIHtcbiAgICAgICAgICAgICAgbmFtZTogdG1wSnNvbkZpbGUuX25hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRtcEpzb25GaWxlLnJlbW92ZUNhbGxiYWNrKCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB6aXAuZmluYWxpemUoKTtcblxuICAgICAgICAgIHRtcFppcFN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBidWYgPSBmcy5yZWFkRmlsZVN5bmModG1wWmlwRmlsZS5uYW1lKTtcbiAgICAgICAgICAgIHRtcFppcEZpbGUucmVtb3ZlQ2FsbGJhY2soKTtcbiAgICAgICAgICAgIHJlc29sdmUoYnVmKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oemlwcGVkRmlsZSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzQ29udHJvbGxlciA9IHJlcS5jb25maWcuZmlsZXNDb250cm9sbGVyO1xuICAgICAgICByZXR1cm4gZmlsZXNDb250cm9sbGVyLmNyZWF0ZUZpbGUoXG4gICAgICAgICAgcmVxLmNvbmZpZyxcbiAgICAgICAgICByZXEuYm9keS5uYW1lLFxuICAgICAgICAgIHppcHBlZEZpbGUsXG4gICAgICAgICAgJ2FwcGxpY2F0aW9uL3ppcCdcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmaWxlRGF0YSA9PiB7XG4gICAgICAgIHJldHVybiBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICB0ZXh0OiBgV2UgaGF2ZSBzdWNjZXNzZnVsbHkgZXhwb3J0ZWQgeW91ciBkYXRhIGZyb20gdGhlIGNsYXNzICR7cmVxLmJvZHkubmFtZX0uXFxuXG4gICAgICAgIFBsZWFzZSBkb3dubG9hZCBmcm9tICR7ZmlsZURhdGEudXJsfWAsXG4gICAgICAgICAgbGluazogZmlsZURhdGEudXJsLFxuICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgIHN1YmplY3Q6ICdFeHBvcnQgY29tcGxldGVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgIHRleHQ6IGBXZSBjb3VsZCBub3QgZXhwb3J0IHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtyZXEuYm9keS5uYW1lfS4gRXJyb3I6ICR7ZXJyb3J9YCxcbiAgICAgICAgICB0bzogcmVxLmJvZHkuZmVlZGJhY2tFbWFpbCxcbiAgICAgICAgICBzdWJqZWN0OiAnRXhwb3J0IGZhaWxlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5kZXN0cm95KFxuICAgICAgICAgIERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLFxuICAgICAgICAgIGV4cG9ydFByb2dyZXNzXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgcmVzcG9uc2U6XG4gICAgICAgICdXZSBhcmUgZXhwb3J0aW5nIHlvdXIgZGF0YS4gWW91IHdpbGwgYmUgbm90aWZpZWQgYnkgZS1tYWlsIG9uY2UgaXQgaXMgY29tcGxldGVkLicsXG4gICAgfSk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKCdQVVQnLCAnL2V4cG9ydF9kYXRhJywgcmVxID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZUV4cG9ydChyZXEpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9leHBvcnRfcHJvZ3Jlc3MnLCByZXEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlRXhwb3J0UHJvZ3Jlc3MocmVxKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFeHBvcnRSb3V0ZXI7XG4iXX0=