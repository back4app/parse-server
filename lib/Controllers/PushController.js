"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PushController = void 0;
var _node = require("parse/node");
var _RestQuery = _interopRequireDefault(require("../RestQuery"));
var _RestWrite = _interopRequireDefault(require("../RestWrite"));
var _Auth = require("../Auth");
var _StatusHandler = require("../StatusHandler");
var _utils = require("../Push/utils");
var _logger = require("../logger");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
class PushController {
  sendPush(body = {}, where = {}, config, auth, onPushStatusSaved = () => {}, now = new Date()) {
    if (!config.hasPushSupport) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Missing push configuration');
    }

    // Replace the expiration_time and push_time with a valid Unix epoch milliseconds time
    body.expiration_time = PushController.getExpirationTime(body);
    body.expiration_interval = PushController.getExpirationInterval(body);
    if (body.expiration_time && body.expiration_interval) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Both expiration_time and expiration_interval cannot be set');
    }

    // Immediate push
    if (body.expiration_interval && !Object.prototype.hasOwnProperty.call(body, 'push_time')) {
      const ttlMs = body.expiration_interval * 1000;
      body.expiration_time = new Date(now.valueOf() + ttlMs).valueOf();
    }
    const pushTime = PushController.getPushTime(body);
    if (pushTime && pushTime.date !== 'undefined') {
      body['push_time'] = PushController.formatPushTime(pushTime);
    }

    // TODO: If the req can pass the checking, we return immediately instead of waiting
    // pushes to be sent. We probably change this behaviour in the future.
    let badgeUpdate = () => {
      return Promise.resolve();
    };
    if (body.data && body.data.badge) {
      const badge = body.data.badge;
      let restUpdate = {};
      if (typeof badge == 'string' && badge.toLowerCase() === 'increment') {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: 1
          }
        };
      } else if (typeof badge == 'object' && typeof badge.__op == 'string' && badge.__op.toLowerCase() == 'increment' && Number(badge.amount)) {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: badge.amount
          }
        };
      } else if (Number(badge)) {
        restUpdate = {
          badge: badge
        };
      } else {
        throw "Invalid value for badge, expected number or 'Increment' or {increment: number}";
      }

      // Force filtering on only valid device tokens
      const updateWhere = (0, _utils.applyDeviceTokenExists)(where);
      badgeUpdate = async () => {
        // Build a real RestQuery so we can use it in RestWrite
        const restQuery = await (0, _RestQuery.default)({
          method: _RestQuery.default.Method.find,
          config,
          runBeforeFind: false,
          auth: (0, _Auth.master)(config),
          className: '_Installation',
          restWhere: updateWhere
        });
        return restQuery.buildRestWhere().then(() => {
          const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Installation', restQuery.restWhere, restUpdate);
          write.runOptions.many = true;
          return write.execute();
        });
      };
    }
    const pushStatus = (0, _StatusHandler.pushStatusHandler)(config);
    return Promise.resolve().then(() => {
      return pushStatus.setInitial(body, where);
    }).then(() => {
      onPushStatusSaved(pushStatus.objectId);
      return badgeUpdate().catch(err => {
        // add this to ignore badge update errors as default
        if (config.stopOnBadgeUpdateError) throw err;
        _logger.logger.info(`Badge update error will be ignored for push status ${pushStatus.objectId}`);
        _logger.logger.info(err && err.stack && err.stack.toString() || err && err.message || err.toString());
        return Promise.resolve();
      });
    }).then(() => {
      // Update audience lastUsed and timesUsed
      if (body.audience_id) {
        const audienceId = body.audience_id;
        var updateAudience = {
          lastUsed: {
            __type: 'Date',
            iso: new Date().toISOString()
          },
          timesUsed: {
            __op: 'Increment',
            amount: 1
          }
        };
        const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Audience', {
          objectId: audienceId
        }, updateAudience);
        write.execute();
      }
      // Don't wait for the audience update promise to resolve.
      return Promise.resolve();
    }).then(() => {
      if (Object.prototype.hasOwnProperty.call(body, 'push_time') && config.hasPushScheduledSupport) {
        return Promise.resolve();
      }
      return config.pushControllerQueue.enqueue(body, where, config, auth, pushStatus);
    }).catch(err => {
      return pushStatus.fail(err).then(() => {
        throw err;
      });
    });
  }

  /**
   * Get expiration time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The expiration time if it exists in the request
   */
  static getExpirationTime(body = {}) {
    var hasExpirationTime = Object.prototype.hasOwnProperty.call(body, 'expiration_time');
    if (!hasExpirationTime) {
      return;
    }
    var expirationTimeParam = body['expiration_time'];
    var expirationTime;
    if (typeof expirationTimeParam === 'number') {
      expirationTime = new Date(expirationTimeParam * 1000);
    } else if (typeof expirationTimeParam === 'string') {
      expirationTime = new Date(expirationTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }
    // Check expirationTime is valid or not, if it is not valid, expirationTime is NaN
    if (!isFinite(expirationTime)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }
    return expirationTime.valueOf();
  }
  static getExpirationInterval(body = {}) {
    const hasExpirationInterval = Object.prototype.hasOwnProperty.call(body, 'expiration_interval');
    if (!hasExpirationInterval) {
      return;
    }
    var expirationIntervalParam = body['expiration_interval'];
    if (typeof expirationIntervalParam !== 'number' || expirationIntervalParam <= 0) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, `expiration_interval must be a number greater than 0`);
    }
    return expirationIntervalParam;
  }

  /**
   * Get push time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The push time if it exists in the request
   */
  static getPushTime(body = {}) {
    var hasPushTime = Object.prototype.hasOwnProperty.call(body, 'push_time');
    if (!hasPushTime) {
      return;
    }
    var pushTimeParam = body['push_time'];
    var date;
    var isLocalTime = true;
    if (typeof pushTimeParam === 'number') {
      date = new Date(pushTimeParam * 1000);
    } else if (typeof pushTimeParam === 'string') {
      isLocalTime = !PushController.pushTimeHasTimezoneComponent(pushTimeParam);
      date = new Date(pushTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }
    // Check pushTime is valid or not, if it is not valid, pushTime is NaN
    if (!isFinite(date)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }
    return {
      date,
      isLocalTime
    };
  }

  /**
   * Checks if a ISO8601 formatted date contains a timezone component
   * @param pushTimeParam {string}
   * @returns {boolean}
   */
  static pushTimeHasTimezoneComponent(pushTimeParam) {
    const offsetPattern = /(.+)([+-])\d\d:\d\d$/;
    return pushTimeParam.indexOf('Z') === pushTimeParam.length - 1 || offsetPattern.test(pushTimeParam) // 2007-04-05T12:30Z
    ; // 2007-04-05T12:30.000+02:00, 2007-04-05T12:30.000-02:00
  }

  /**
   * Converts a date to ISO format in UTC time and strips the timezone if `isLocalTime` is true
   * @param date {Date}
   * @param isLocalTime {boolean}
   * @returns {string}
   */
  static formatPushTime({
    date,
    isLocalTime
  }) {
    if (isLocalTime) {
      // Strip 'Z'
      const isoString = date.toISOString();
      return isoString.substring(0, isoString.indexOf('Z'));
    }
    return date.toISOString();
  }
}
exports.PushController = PushController;
var _default = exports.default = PushController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbm9kZSIsInJlcXVpcmUiLCJfUmVzdFF1ZXJ5IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9SZXN0V3JpdGUiLCJfQXV0aCIsIl9TdGF0dXNIYW5kbGVyIiwiX3V0aWxzIiwiX2xvZ2dlciIsImUiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIlB1c2hDb250cm9sbGVyIiwic2VuZFB1c2giLCJib2R5Iiwid2hlcmUiLCJjb25maWciLCJhdXRoIiwib25QdXNoU3RhdHVzU2F2ZWQiLCJub3ciLCJEYXRlIiwiaGFzUHVzaFN1cHBvcnQiLCJQYXJzZSIsIkVycm9yIiwiUFVTSF9NSVNDT05GSUdVUkVEIiwiZXhwaXJhdGlvbl90aW1lIiwiZ2V0RXhwaXJhdGlvblRpbWUiLCJleHBpcmF0aW9uX2ludGVydmFsIiwiZ2V0RXhwaXJhdGlvbkludGVydmFsIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwidHRsTXMiLCJ2YWx1ZU9mIiwicHVzaFRpbWUiLCJnZXRQdXNoVGltZSIsImRhdGUiLCJmb3JtYXRQdXNoVGltZSIsImJhZGdlVXBkYXRlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJkYXRhIiwiYmFkZ2UiLCJyZXN0VXBkYXRlIiwidG9Mb3dlckNhc2UiLCJfX29wIiwiYW1vdW50IiwiTnVtYmVyIiwidXBkYXRlV2hlcmUiLCJhcHBseURldmljZVRva2VuRXhpc3RzIiwicmVzdFF1ZXJ5IiwiUmVzdFF1ZXJ5IiwibWV0aG9kIiwiTWV0aG9kIiwiZmluZCIsInJ1bkJlZm9yZUZpbmQiLCJtYXN0ZXIiLCJjbGFzc05hbWUiLCJyZXN0V2hlcmUiLCJidWlsZFJlc3RXaGVyZSIsInRoZW4iLCJ3cml0ZSIsIlJlc3RXcml0ZSIsInJ1bk9wdGlvbnMiLCJtYW55IiwiZXhlY3V0ZSIsInB1c2hTdGF0dXMiLCJwdXNoU3RhdHVzSGFuZGxlciIsInNldEluaXRpYWwiLCJvYmplY3RJZCIsImNhdGNoIiwiZXJyIiwic3RvcE9uQmFkZ2VVcGRhdGVFcnJvciIsImxvZ2dlciIsImluZm8iLCJzdGFjayIsInRvU3RyaW5nIiwibWVzc2FnZSIsImF1ZGllbmNlX2lkIiwiYXVkaWVuY2VJZCIsInVwZGF0ZUF1ZGllbmNlIiwibGFzdFVzZWQiLCJfX3R5cGUiLCJpc28iLCJ0b0lTT1N0cmluZyIsInRpbWVzVXNlZCIsImhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0IiwicHVzaENvbnRyb2xsZXJRdWV1ZSIsImVucXVldWUiLCJmYWlsIiwiaGFzRXhwaXJhdGlvblRpbWUiLCJleHBpcmF0aW9uVGltZVBhcmFtIiwiZXhwaXJhdGlvblRpbWUiLCJpc0Zpbml0ZSIsImhhc0V4cGlyYXRpb25JbnRlcnZhbCIsImV4cGlyYXRpb25JbnRlcnZhbFBhcmFtIiwiaGFzUHVzaFRpbWUiLCJwdXNoVGltZVBhcmFtIiwiaXNMb2NhbFRpbWUiLCJwdXNoVGltZUhhc1RpbWV6b25lQ29tcG9uZW50Iiwib2Zmc2V0UGF0dGVybiIsImluZGV4T2YiLCJsZW5ndGgiLCJ0ZXN0IiwiaXNvU3RyaW5nIiwic3Vic3RyaW5nIiwiZXhwb3J0cyIsIl9kZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL0NvbnRyb2xsZXJzL1B1c2hDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcnNlIH0gZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgUmVzdFF1ZXJ5IGZyb20gJy4uL1Jlc3RRdWVyeSc7XG5pbXBvcnQgUmVzdFdyaXRlIGZyb20gJy4uL1Jlc3RXcml0ZSc7XG5pbXBvcnQgeyBtYXN0ZXIgfSBmcm9tICcuLi9BdXRoJztcbmltcG9ydCB7IHB1c2hTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgeyBhcHBseURldmljZVRva2VuRXhpc3RzIH0gZnJvbSAnLi4vUHVzaC91dGlscyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi9sb2dnZXInO1xuXG5leHBvcnQgY2xhc3MgUHVzaENvbnRyb2xsZXIge1xuICBzZW5kUHVzaChib2R5ID0ge30sIHdoZXJlID0ge30sIGNvbmZpZywgYXV0aCwgb25QdXNoU3RhdHVzU2F2ZWQgPSAoKSA9PiB7fSwgbm93ID0gbmV3IERhdGUoKSkge1xuICAgIGlmICghY29uZmlnLmhhc1B1c2hTdXBwb3J0KSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELCAnTWlzc2luZyBwdXNoIGNvbmZpZ3VyYXRpb24nKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIHRoZSBleHBpcmF0aW9uX3RpbWUgYW5kIHB1c2hfdGltZSB3aXRoIGEgdmFsaWQgVW5peCBlcG9jaCBtaWxsaXNlY29uZHMgdGltZVxuICAgIGJvZHkuZXhwaXJhdGlvbl90aW1lID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvblRpbWUoYm9keSk7XG4gICAgYm9keS5leHBpcmF0aW9uX2ludGVydmFsID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvbkludGVydmFsKGJvZHkpO1xuICAgIGlmIChib2R5LmV4cGlyYXRpb25fdGltZSAmJiBib2R5LmV4cGlyYXRpb25faW50ZXJ2YWwpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICAnQm90aCBleHBpcmF0aW9uX3RpbWUgYW5kIGV4cGlyYXRpb25faW50ZXJ2YWwgY2Fubm90IGJlIHNldCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSW1tZWRpYXRlIHB1c2hcbiAgICBpZiAoYm9keS5leHBpcmF0aW9uX2ludGVydmFsICYmICFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYm9keSwgJ3B1c2hfdGltZScpKSB7XG4gICAgICBjb25zdCB0dGxNcyA9IGJvZHkuZXhwaXJhdGlvbl9pbnRlcnZhbCAqIDEwMDA7XG4gICAgICBib2R5LmV4cGlyYXRpb25fdGltZSA9IG5ldyBEYXRlKG5vdy52YWx1ZU9mKCkgKyB0dGxNcykudmFsdWVPZigpO1xuICAgIH1cblxuICAgIGNvbnN0IHB1c2hUaW1lID0gUHVzaENvbnRyb2xsZXIuZ2V0UHVzaFRpbWUoYm9keSk7XG4gICAgaWYgKHB1c2hUaW1lICYmIHB1c2hUaW1lLmRhdGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBib2R5WydwdXNoX3RpbWUnXSA9IFB1c2hDb250cm9sbGVyLmZvcm1hdFB1c2hUaW1lKHB1c2hUaW1lKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBJZiB0aGUgcmVxIGNhbiBwYXNzIHRoZSBjaGVja2luZywgd2UgcmV0dXJuIGltbWVkaWF0ZWx5IGluc3RlYWQgb2Ygd2FpdGluZ1xuICAgIC8vIHB1c2hlcyB0byBiZSBzZW50LiBXZSBwcm9iYWJseSBjaGFuZ2UgdGhpcyBiZWhhdmlvdXIgaW4gdGhlIGZ1dHVyZS5cbiAgICBsZXQgYmFkZ2VVcGRhdGUgPSAoKSA9PiB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfTtcblxuICAgIGlmIChib2R5LmRhdGEgJiYgYm9keS5kYXRhLmJhZGdlKSB7XG4gICAgICBjb25zdCBiYWRnZSA9IGJvZHkuZGF0YS5iYWRnZTtcbiAgICAgIGxldCByZXN0VXBkYXRlID0ge307XG4gICAgICBpZiAodHlwZW9mIGJhZGdlID09ICdzdHJpbmcnICYmIGJhZGdlLnRvTG93ZXJDYXNlKCkgPT09ICdpbmNyZW1lbnQnKSB7XG4gICAgICAgIHJlc3RVcGRhdGUgPSB7IGJhZGdlOiB7IF9fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IDEgfSB9O1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgdHlwZW9mIGJhZGdlID09ICdvYmplY3QnICYmXG4gICAgICAgIHR5cGVvZiBiYWRnZS5fX29wID09ICdzdHJpbmcnICYmXG4gICAgICAgIGJhZGdlLl9fb3AudG9Mb3dlckNhc2UoKSA9PSAnaW5jcmVtZW50JyAmJlxuICAgICAgICBOdW1iZXIoYmFkZ2UuYW1vdW50KVxuICAgICAgKSB7XG4gICAgICAgIHJlc3RVcGRhdGUgPSB7IGJhZGdlOiB7IF9fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IGJhZGdlLmFtb3VudCB9IH07XG4gICAgICB9IGVsc2UgaWYgKE51bWJlcihiYWRnZSkpIHtcbiAgICAgICAgcmVzdFVwZGF0ZSA9IHsgYmFkZ2U6IGJhZGdlIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBcIkludmFsaWQgdmFsdWUgZm9yIGJhZGdlLCBleHBlY3RlZCBudW1iZXIgb3IgJ0luY3JlbWVudCcgb3Ige2luY3JlbWVudDogbnVtYmVyfVwiO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3JjZSBmaWx0ZXJpbmcgb24gb25seSB2YWxpZCBkZXZpY2UgdG9rZW5zXG4gICAgICBjb25zdCB1cGRhdGVXaGVyZSA9IGFwcGx5RGV2aWNlVG9rZW5FeGlzdHMod2hlcmUpO1xuICAgICAgYmFkZ2VVcGRhdGUgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIEJ1aWxkIGEgcmVhbCBSZXN0UXVlcnkgc28gd2UgY2FuIHVzZSBpdCBpbiBSZXN0V3JpdGVcbiAgICAgICAgY29uc3QgcmVzdFF1ZXJ5ID0gYXdhaXQgUmVzdFF1ZXJ5KHtcbiAgICAgICAgICBtZXRob2Q6IFJlc3RRdWVyeS5NZXRob2QuZmluZCxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgcnVuQmVmb3JlRmluZDogZmFsc2UsXG4gICAgICAgICAgYXV0aDogbWFzdGVyKGNvbmZpZyksXG4gICAgICAgICAgY2xhc3NOYW1lOiAnX0luc3RhbGxhdGlvbicsXG4gICAgICAgICAgcmVzdFdoZXJlOiB1cGRhdGVXaGVyZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN0UXVlcnkuYnVpbGRSZXN0V2hlcmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICBjb25zdCB3cml0ZSA9IG5ldyBSZXN0V3JpdGUoXG4gICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICBtYXN0ZXIoY29uZmlnKSxcbiAgICAgICAgICAgICdfSW5zdGFsbGF0aW9uJyxcbiAgICAgICAgICAgIHJlc3RRdWVyeS5yZXN0V2hlcmUsXG4gICAgICAgICAgICByZXN0VXBkYXRlXG4gICAgICAgICAgKTtcbiAgICAgICAgICB3cml0ZS5ydW5PcHRpb25zLm1hbnkgPSB0cnVlO1xuICAgICAgICAgIHJldHVybiB3cml0ZS5leGVjdXRlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgcHVzaFN0YXR1cyA9IHB1c2hTdGF0dXNIYW5kbGVyKGNvbmZpZyk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiBwdXNoU3RhdHVzLnNldEluaXRpYWwoYm9keSwgd2hlcmUpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgb25QdXNoU3RhdHVzU2F2ZWQocHVzaFN0YXR1cy5vYmplY3RJZCk7XG4gICAgICAgIHJldHVybiBiYWRnZVVwZGF0ZSgpLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgLy8gYWRkIHRoaXMgdG8gaWdub3JlIGJhZGdlIHVwZGF0ZSBlcnJvcnMgYXMgZGVmYXVsdFxuICAgICAgICAgIGlmIChjb25maWcuc3RvcE9uQmFkZ2VVcGRhdGVFcnJvcikgdGhyb3cgZXJyO1xuICAgICAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICAgICAgYEJhZGdlIHVwZGF0ZSBlcnJvciB3aWxsIGJlIGlnbm9yZWQgZm9yIHB1c2ggc3RhdHVzICR7cHVzaFN0YXR1cy5vYmplY3RJZH1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICAgIChlcnIgJiYgZXJyLnN0YWNrICYmIGVyci5zdGFjay50b1N0cmluZygpKSB8fFxuICAgICAgICAgICAgICAoZXJyICYmIGVyci5tZXNzYWdlKSB8fFxuICAgICAgICAgICAgICBlcnIudG9TdHJpbmcoKVxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIC8vIFVwZGF0ZSBhdWRpZW5jZSBsYXN0VXNlZCBhbmQgdGltZXNVc2VkXG4gICAgICAgIGlmIChib2R5LmF1ZGllbmNlX2lkKSB7XG4gICAgICAgICAgY29uc3QgYXVkaWVuY2VJZCA9IGJvZHkuYXVkaWVuY2VfaWQ7XG5cbiAgICAgICAgICB2YXIgdXBkYXRlQXVkaWVuY2UgPSB7XG4gICAgICAgICAgICBsYXN0VXNlZDogeyBfX3R5cGU6ICdEYXRlJywgaXNvOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSxcbiAgICAgICAgICAgIHRpbWVzVXNlZDogeyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiAxIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgICBjb25zdCB3cml0ZSA9IG5ldyBSZXN0V3JpdGUoXG4gICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICBtYXN0ZXIoY29uZmlnKSxcbiAgICAgICAgICAgICdfQXVkaWVuY2UnLFxuICAgICAgICAgICAgeyBvYmplY3RJZDogYXVkaWVuY2VJZCB9LFxuICAgICAgICAgICAgdXBkYXRlQXVkaWVuY2VcbiAgICAgICAgICApO1xuICAgICAgICAgIHdyaXRlLmV4ZWN1dGUoKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBEb24ndCB3YWl0IGZvciB0aGUgYXVkaWVuY2UgdXBkYXRlIHByb21pc2UgdG8gcmVzb2x2ZS5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChib2R5LCAncHVzaF90aW1lJykgJiZcbiAgICAgICAgICBjb25maWcuaGFzUHVzaFNjaGVkdWxlZFN1cHBvcnRcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb25maWcucHVzaENvbnRyb2xsZXJRdWV1ZS5lbnF1ZXVlKGJvZHksIHdoZXJlLCBjb25maWcsIGF1dGgsIHB1c2hTdGF0dXMpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICByZXR1cm4gcHVzaFN0YXR1cy5mYWlsKGVycikudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBleHBpcmF0aW9uIHRpbWUgZnJvbSB0aGUgcmVxdWVzdCBib2R5LlxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCBBIHJlcXVlc3Qgb2JqZWN0XG4gICAqIEByZXR1cm5zIHtOdW1iZXJ8dW5kZWZpbmVkfSBUaGUgZXhwaXJhdGlvbiB0aW1lIGlmIGl0IGV4aXN0cyBpbiB0aGUgcmVxdWVzdFxuICAgKi9cbiAgc3RhdGljIGdldEV4cGlyYXRpb25UaW1lKGJvZHkgPSB7fSkge1xuICAgIHZhciBoYXNFeHBpcmF0aW9uVGltZSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChib2R5LCAnZXhwaXJhdGlvbl90aW1lJyk7XG4gICAgaWYgKCFoYXNFeHBpcmF0aW9uVGltZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZXhwaXJhdGlvblRpbWVQYXJhbSA9IGJvZHlbJ2V4cGlyYXRpb25fdGltZSddO1xuICAgIHZhciBleHBpcmF0aW9uVGltZTtcbiAgICBpZiAodHlwZW9mIGV4cGlyYXRpb25UaW1lUGFyYW0gPT09ICdudW1iZXInKSB7XG4gICAgICBleHBpcmF0aW9uVGltZSA9IG5ldyBEYXRlKGV4cGlyYXRpb25UaW1lUGFyYW0gKiAxMDAwKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBpcmF0aW9uVGltZVBhcmFtID09PSAnc3RyaW5nJykge1xuICAgICAgZXhwaXJhdGlvblRpbWUgPSBuZXcgRGF0ZShleHBpcmF0aW9uVGltZVBhcmFtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ2V4cGlyYXRpb25fdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBDaGVjayBleHBpcmF0aW9uVGltZSBpcyB2YWxpZCBvciBub3QsIGlmIGl0IGlzIG5vdCB2YWxpZCwgZXhwaXJhdGlvblRpbWUgaXMgTmFOXG4gICAgaWYgKCFpc0Zpbml0ZShleHBpcmF0aW9uVGltZSkpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICBib2R5WydleHBpcmF0aW9uX3RpbWUnXSArICcgaXMgbm90IHZhbGlkIHRpbWUuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGV4cGlyYXRpb25UaW1lLnZhbHVlT2YoKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRFeHBpcmF0aW9uSW50ZXJ2YWwoYm9keSA9IHt9KSB7XG4gICAgY29uc3QgaGFzRXhwaXJhdGlvbkludGVydmFsID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGJvZHksICdleHBpcmF0aW9uX2ludGVydmFsJyk7XG4gICAgaWYgKCFoYXNFeHBpcmF0aW9uSW50ZXJ2YWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgZXhwaXJhdGlvbkludGVydmFsUGFyYW0gPSBib2R5WydleHBpcmF0aW9uX2ludGVydmFsJ107XG4gICAgaWYgKHR5cGVvZiBleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSAhPT0gJ251bWJlcicgfHwgZXhwaXJhdGlvbkludGVydmFsUGFyYW0gPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGBleHBpcmF0aW9uX2ludGVydmFsIG11c3QgYmUgYSBudW1iZXIgZ3JlYXRlciB0aGFuIDBgXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZXhwaXJhdGlvbkludGVydmFsUGFyYW07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHB1c2ggdGltZSBmcm9tIHRoZSByZXF1ZXN0IGJvZHkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IEEgcmVxdWVzdCBvYmplY3RcbiAgICogQHJldHVybnMge051bWJlcnx1bmRlZmluZWR9IFRoZSBwdXNoIHRpbWUgaWYgaXQgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gICAqL1xuICBzdGF0aWMgZ2V0UHVzaFRpbWUoYm9keSA9IHt9KSB7XG4gICAgdmFyIGhhc1B1c2hUaW1lID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGJvZHksICdwdXNoX3RpbWUnKTtcbiAgICBpZiAoIWhhc1B1c2hUaW1lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBwdXNoVGltZVBhcmFtID0gYm9keVsncHVzaF90aW1lJ107XG4gICAgdmFyIGRhdGU7XG4gICAgdmFyIGlzTG9jYWxUaW1lID0gdHJ1ZTtcblxuICAgIGlmICh0eXBlb2YgcHVzaFRpbWVQYXJhbSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGRhdGUgPSBuZXcgRGF0ZShwdXNoVGltZVBhcmFtICogMTAwMCk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcHVzaFRpbWVQYXJhbSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlzTG9jYWxUaW1lID0gIVB1c2hDb250cm9sbGVyLnB1c2hUaW1lSGFzVGltZXpvbmVDb21wb25lbnQocHVzaFRpbWVQYXJhbSk7XG4gICAgICBkYXRlID0gbmV3IERhdGUocHVzaFRpbWVQYXJhbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICBib2R5WydwdXNoX3RpbWUnXSArICcgaXMgbm90IHZhbGlkIHRpbWUuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgLy8gQ2hlY2sgcHVzaFRpbWUgaXMgdmFsaWQgb3Igbm90LCBpZiBpdCBpcyBub3QgdmFsaWQsIHB1c2hUaW1lIGlzIE5hTlxuICAgIGlmICghaXNGaW5pdGUoZGF0ZSkpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICBib2R5WydwdXNoX3RpbWUnXSArICcgaXMgbm90IHZhbGlkIHRpbWUuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGF0ZSxcbiAgICAgIGlzTG9jYWxUaW1lLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGEgSVNPODYwMSBmb3JtYXR0ZWQgZGF0ZSBjb250YWlucyBhIHRpbWV6b25lIGNvbXBvbmVudFxuICAgKiBAcGFyYW0gcHVzaFRpbWVQYXJhbSB7c3RyaW5nfVxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICovXG4gIHN0YXRpYyBwdXNoVGltZUhhc1RpbWV6b25lQ29tcG9uZW50KHB1c2hUaW1lUGFyYW06IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9mZnNldFBhdHRlcm4gPSAvKC4rKShbKy1dKVxcZFxcZDpcXGRcXGQkLztcbiAgICByZXR1cm4gKFxuICAgICAgcHVzaFRpbWVQYXJhbS5pbmRleE9mKCdaJykgPT09IHB1c2hUaW1lUGFyYW0ubGVuZ3RoIC0gMSB8fCBvZmZzZXRQYXR0ZXJuLnRlc3QocHVzaFRpbWVQYXJhbSkgLy8gMjAwNy0wNC0wNVQxMjozMFpcbiAgICApOyAvLyAyMDA3LTA0LTA1VDEyOjMwLjAwMCswMjowMCwgMjAwNy0wNC0wNVQxMjozMC4wMDAtMDI6MDBcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyBhIGRhdGUgdG8gSVNPIGZvcm1hdCBpbiBVVEMgdGltZSBhbmQgc3RyaXBzIHRoZSB0aW1lem9uZSBpZiBgaXNMb2NhbFRpbWVgIGlzIHRydWVcbiAgICogQHBhcmFtIGRhdGUge0RhdGV9XG4gICAqIEBwYXJhbSBpc0xvY2FsVGltZSB7Ym9vbGVhbn1cbiAgICogQHJldHVybnMge3N0cmluZ31cbiAgICovXG4gIHN0YXRpYyBmb3JtYXRQdXNoVGltZSh7IGRhdGUsIGlzTG9jYWxUaW1lIH06IHsgZGF0ZTogRGF0ZSwgaXNMb2NhbFRpbWU6IGJvb2xlYW4gfSkge1xuICAgIGlmIChpc0xvY2FsVGltZSkge1xuICAgICAgLy8gU3RyaXAgJ1onXG4gICAgICBjb25zdCBpc29TdHJpbmcgPSBkYXRlLnRvSVNPU3RyaW5nKCk7XG4gICAgICByZXR1cm4gaXNvU3RyaW5nLnN1YnN0cmluZygwLCBpc29TdHJpbmcuaW5kZXhPZignWicpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQdXNoQ29udHJvbGxlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsS0FBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsVUFBQSxHQUFBQyxzQkFBQSxDQUFBRixPQUFBO0FBQ0EsSUFBQUcsVUFBQSxHQUFBRCxzQkFBQSxDQUFBRixPQUFBO0FBQ0EsSUFBQUksS0FBQSxHQUFBSixPQUFBO0FBQ0EsSUFBQUssY0FBQSxHQUFBTCxPQUFBO0FBQ0EsSUFBQU0sTUFBQSxHQUFBTixPQUFBO0FBQ0EsSUFBQU8sT0FBQSxHQUFBUCxPQUFBO0FBQW1DLFNBQUFFLHVCQUFBTSxDQUFBLFdBQUFBLENBQUEsSUFBQUEsQ0FBQSxDQUFBQyxVQUFBLEdBQUFELENBQUEsS0FBQUUsT0FBQSxFQUFBRixDQUFBO0FBRTVCLE1B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